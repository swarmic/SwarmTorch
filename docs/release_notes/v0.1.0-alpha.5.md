# SwarmTorch v0.1.0-alpha.5 Release Notes

**Date:** 2026-02-09  
**Type:** DataOps Wiring + ExecutionPolicy Integration  

## Summary

This release wires the DataOps primitives to artifact emission and introduces ExecutionPolicy enforcement. Key theme: **trust propagation** — untrusted inputs or non-Core execution automatically marks outputs as unsafe.

**Fixes in this release:**
- **no_std+alloc regression:** Added `use alloc::format;` import in `execution.rs`
- **Multi-output fingerprint collision:** Salted `source_fp` with `derived:{asset_key}` to ensure unique fingerprints

---

## Key Changes

### 1. DataOpsSession (Single Derivation Point)

**File:** `swarm-torch/src/artifacts.rs`

**What:** New `DataOpsSession` struct that manages registry/lineage with crash-safe persistence.

**Key API:**
```rust
pub fn register_source(&mut self, asset_key, trust, source, schema, ingest_node) -> io::Result<()>;
pub fn materialize_node_outputs(&mut self, node, outputs, ts, cache_hit, duration_ms) -> io::Result<()>;
pub fn finalize(&self) -> io::Result<()>;
```

**Design decisions:**
- Uses `Arc<RunArtifactSink>` for coexistence with span/event/metric emission
- BTreeMap for registry (keyed by `asset_key`) and lineage (keyed by `(input_fp, output_fp, node_id_str)`)
- `flush_snapshots()` called after each materialization for crash-safety
- 64-char lowercase hex for all `*_fingerprint_v0` fields

### 2. Trust Propagation

**Invariant:** Output `trust = Untrusted` if:
- Any input has `trust = Untrusted`, OR
- `execution_trust != Core`

This ensures taint flows through the DAG automatically.

### 3. ExecutionPolicy Implementations

**File:** `swarm-torch-core/src/execution.rs`

| Policy | Behavior |
|--------|----------|
| `CoreOnlyPolicy` | Allows only `ExecutionTrust::Core`; denies SandboxedExtension/UnsafeExtension |
| `PermissivePolicy` | Allows all (for tests/dev) |

### 4. Report JSON Export

**File:** `swarm-torch/src/report.rs`, `swarm-torch/src/bin/swarm_torch_report.rs`

- `Report` struct now derives `Serialize`
- New `generate_report(run_dir, html_out, json_out)` function
- CLI flag `--json-out <path>` writes pretty-printed JSON alongside HTML

---

## Tests Added

| Test | Invariant |
|------|-----------|
| `fingerprint_changes_when_node_def_changes` | Different params → different fingerprint |
| `fingerprint_changes_when_upstream_changes` | Different upstream → different fingerprint |
| `multi_output_fingerprints_unique` | Same node, same schema, different outputs → unique fingerprints |
| `lineage_dedupes_repeated_edges` | Same edge twice → one entry |
| `snapshot_determinism` | Write twice → byte-identical |
| `trust_propagates_from_untrusted_input` | Untrusted input → output Untrusted |
| `trust_propagates_from_unsafe_extension` | UnsafeExtension → output Untrusted |
| `policy_allows_core_trust` | CoreOnlyPolicy allows Core |
| `policy_denies_sandboxed_extension` | CoreOnlyPolicy denies SandboxedExtension |
| `policy_denies_unsafe_extension` | CoreOnlyPolicy denies UnsafeExtension |
| `permissive_allows_all` | PermissivePolicy allows all |

---

## Documented Limitations

**Single-process writer per run directory:**
```rust
/// **Limitation (v0.1):** Single-process writer per run directory.
/// The `RunArtifactSink` mutex is in-process only; concurrent processes
/// writing to the same bundle will corrupt NDJSON files.
```

**Manifest gap:**
```rust
/// **Manifest gap:** `flush_snapshots()` writes registry.json/lineage.json after each
/// materialization but does NOT update manifest.json. Call `finalize()` before reading
/// the bundle with report tools (which validate manifest hashes). After a crash mid-session,
/// the manifest will be stale and report generation will fail until `finalize()` is called.
```

---

## Verification

```bash
cargo test --workspace                  # All pass
cargo test -p swarm-torch artifacts::tests::   # 8 pass
cargo test -p swarm-torch-core execution::tests::  # 4 pass
```

---

## ADR References

- ADR-0016: Artifact spine schema (registry.json, lineage.json, materializations.ndjson)
- ADR-0017: Deterministic hashing (recipe_hash_v0, dataset_fingerprint_v0)
- ADR-0018: ExecutionPolicy + OpRunner boundaries
