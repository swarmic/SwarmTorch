# SwarmTorch M4-02.5: Replay Protection Hardening

**Date:** 2026-02-13  
**Type:** Security hardening + API contract clarification  
**Builds on:** M4-02 (Replay Protection Enforcement)

## Summary

M4-02.5 closes critical hardening gaps identified during post-M4-02 audit:

- Explicit sender identity contract (`MessageEnvelope.sender` = raw Ed25519 public key bytes)
- Fallible replay configuration (`try_with_config`) with stable compatibility constructor
- Overflow-safe replay window arithmetic near `u64::MAX`
- Explicit time source errors and safe Unix-seconds helper
- Version gate before replay state mutation
- Enforced receive-path wrapper (`AuthenticatedEnvelopeVerifier`)

## Key Changes

### 1. Sender Identity Contract (ADR-0008B)

**File:** `swarm-torch-net/src/protocol.rs`

- Added `MessageEnvelope::new_with_public_key([u8; 32], ...)` as the primary constructor.
- Deprecated `MessageEnvelope::new(PeerId, ...)` to avoid hashed-identity misuse.
- Added `sender_public_key()` and `sender_peer_id()` helper accessors.

### 2. Replay Config Hardening

**File:** `swarm-torch-core/src/replay.rs`

- Added `ReplayConfigError::ZeroCapacity`.
- Added `ReplayProtection::try_with_config(...) -> Result<_, ReplayConfigError>`.
- Kept `with_config(...)` behavior stable (still panics on zero capacity).
- Removed panic path from `ReplayProtection::new()`.

### 3. Overflow and Version Safety

**Files:** `swarm-torch-core/src/replay.rs`, `swarm-torch-net/src/protocol.rs`

- Replaced replay window checks with saturating arithmetic to avoid overflow near `u64::MAX`.
- Added supported-version gate to `verify_authenticated()` before any state mutation.
- Added `VerifyError::UnsupportedVersion`.

### 4. Time Safety and Enforcement Wrapper

**File:** `swarm-torch-net/src/protocol.rs`

- Added `TimeError::{BeforeEpoch, Overflow}`.
- Added `MessageEnvelope::current_unix_secs() -> Result<u32, TimeError>`.
- Added `VerifyError::Time(TimeError)`.
- Added `AuthenticatedEnvelopeVerifier` with:
  - `verify_and_unwrap(...)` (std wall-clock)
  - `verify_and_unwrap_with_time(...)` (explicit time injection)

### 5. Test Coverage Additions

**Files:** `swarm-torch-core/src/replay.rs`, `swarm-torch-net/tests/replay_integration.rs`

- Added tests for:
  - zero-capacity replay config rejection
  - sequence overflow handling at `u64::MAX`
  - raw-public-key sender constructor semantics
  - deprecated constructor compatibility path
  - hashed peer-id sender rejection
  - unix-seconds vs milliseconds misuse
  - unsupported version rejection

## Documentation Alignment

Updated canonical docs in the same change:

- `ADRs.md`: added ADR-0008B sender identity contract
- `SWARM_TORCH_TECHNICAL_WHITE_PAPER_v0.1.md`: corrected message auth and replay status to implemented
- `SECURITY.md`: added sender identity contract status

## Deferred to M4-03

- Persistent replay cache
- Startup policy for replay state bootstrapping
- Unknown-peer/DoS policy hardening and metrics
